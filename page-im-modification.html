<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lomse library. API documentation: The low level edition API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.27.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page-im-modification.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The low level edition API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#im-modification-intro">Low level edition API overview</a><ul><li class="level2"><a href="#im-modification-intro-example-1">1. The basics</a></li>
<li class="level2"><a href="#im-modification-intro-example-2">2. Editing an existing document</a></li>
<li class="level2"><a href="#im-modification-intro-example-3">3. Different ways for creating notes</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="im-modification-intro"></a>
Low level edition API overview</h1>
<p>When using the low level edition API your application will be interacting directly with the <em>Internal Model</em>. You should know what you are doing; otherwise, there is a risk of corrupting the <em>Internal Model</em> and causing crashes.</p>
<p>To get a quick idea in this section you will find some explained examples of different complexity for building and editing music scores and documents.</p>
<h2><a class="anchor" id="im-modification-intro-example-1"></a>
1. The basics</h2>
<p>Let's create a music score from scratch:</p>
<div class="fragment"><div class="line"><span class="comment">//create empty document</span></div><div class="line"><span class="keyword">delete</span> m_pPresenter;</div><div class="line">m_pPresenter = m_lomse.new_document(ViewFactory::k_view_vertical_book);</div><div class="line"></div><div class="line"><span class="comment">//Add content to the document</span></div><div class="line"><span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div><div class="line">{</div><div class="line">    <span class="comment">//get the document to edit</span></div><div class="line">    <a class="code" href="classDocument.html">Document</a>* pDoc = m_pPresenter-&gt;get_document_raw_ptr();</div><div class="line"></div><div class="line">    <span class="comment">//add an empty score to the document</span></div><div class="line">    ImoScore* pScore = pDoc-&gt;<a class="code" href="classDocument.html#aa26dcafd3c5cd6f6d597893c49755309">add_score</a>();</div><div class="line"></div><div class="line">    <span class="comment">//add an instrument (an score part) to the score</span></div><div class="line">    ImoInstrument* pInstr = pScore-&gt;add_instrument();</div><div class="line"></div><div class="line">    <span class="comment">//add some content to this instrument</span></div><div class="line">    pInstr-&gt;add_clef(<a class="code" href="group__enumerations.html#ggae2b8bc4155c37c3b10224456733664e4a34698de0a0d67e464fab9bbc29366173">k_clef_G2</a>);            <span class="comment">//G clef on second line</span></div><div class="line">    pInstr-&gt;add_key_signature(<a class="code" href="group__enumerations.html#gga6fcf17d0c9110b9471e695a30cf81959a4e4377b7e697f166796c989f6e901d88">k_key_D</a>);     <span class="comment">//D major key signature</span></div><div class="line">    pInstr-&gt;add_time_signature(2, 4);       <span class="comment">// 2/4 time signature</span></div><div class="line">    pInstr-&gt;add_staff_objects(<span class="stringliteral">&quot;(n d5 q)(n a4 q)&quot;</span>);  <span class="comment">//two quarter notes D5 and A4</span></div><div class="line">    pInstr-&gt;add_barline(<a class="code" href="group__enumerations.html#ggac2b9227b141b8d8aff14a30886e81b98a028db26569fdf7738920fddbbf20a0f5">k_barline_end</a>);     <span class="comment">//and a final barline</span></div><div class="line"></div><div class="line">    <span class="comment">//update the internal data structures</span></div><div class="line">    pDoc-&gt;<a class="code" href="classDocument.html#ab54f9738b907ee39df924853813d10bc">end_of_changes</a>();</div><div class="line">}</div></div><!-- fragment --><p>Here's what you should get: </p><div class="left-aligned"> <div class="image">
<img src="im-modification-api-1.png" alt="im-modification-api-1.png"/>
<div class="caption">
Example 1: Score generated by previous code.</div></div>
</div><p>Notice that when we have finished modifying a document it is necessary to update all necessary internal data structures. For this, you must invoke <code>pDoc-&gt;end_of_changes()</code>. This method updates the internal data structures for each music score in the document. Alternatively, as we know that the only modified score is the one pointed by <code>pScore</code> we can save procesing time by just invoking <code>pScore-&gt;end_of_changes()</code>.</p>
<p>Also notice that appart from specific methods for creating each object type, such as adding a clef by using method <code>add_clef()</code> or <code>add_time_signature()</code>, it is also posible to use generic methods that takes as parameter the LDP source code for the objects to add, as we did for adding the notes. Here you have an alternative to previous example code:</p>
<div class="fragment"><div class="line">ImoInstrument* instr = pScore-&gt;add_instrument();</div><div class="line">instr-&gt;add_object( <span class="stringliteral">&quot;(clef G2)&quot;</span> );                    </div><div class="line">instr-&gt;add_object( <span class="stringliteral">&quot;(key D)&quot;</span> );</div><div class="line">instr-&gt;add_object( <span class="stringliteral">&quot;(time 2 4)&quot;</span> );</div><div class="line">instr-&gt;add_object( <span class="stringliteral">&quot;(n d4 q)&quot;</span> );</div><div class="line">instr-&gt;add_object( <span class="stringliteral">&quot;(n a4 q)&quot;</span> );</div><div class="line">instr-&gt;add_object( <span class="stringliteral">&quot;(barline end)&quot;</span> );</div><div class="line">pScore-&gt;end_of_changes();</div></div><!-- fragment --><h2><a class="anchor" id="im-modification-intro-example-2"></a>
2. Editing an existing document</h2>
<p>In this second example, lets edit an existing document. It is irrelevant how the <a class="el" href="classDocument.html">Document</a> was created. So, lets use the document created in previous example, and lets add a second voice with a single half note to this tune:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div><div class="line">{</div><div class="line">    <span class="comment">//get the document to edit</span></div><div class="line">    <a class="code" href="classDocument.html">Document</a>* pDoc = m_pPresenter-&gt;get_document_raw_ptr();</div><div class="line"></div><div class="line">    <span class="comment">//Use the document to get the score to edit</span></div><div class="line">    <span class="comment">//The next line of code is just an example, in which it is assumed that</span></div><div class="line">    <span class="comment">//the score to edit is the first element in the document, as it is the case if we</span></div><div class="line">    <span class="comment">//use the document created in previous example. Also, this will be always the</span></div><div class="line">    <span class="comment">//case when editing MusicXML imported files.</span></div><div class="line">    ImoScore* pScore = <span class="keyword">dynamic_cast&lt;</span>ImoScore*<span class="keyword">&gt;</span>( pDoc-&gt;<a class="code" href="classDocument.html#a07d8a430a6994f06b77ce2e2d6a87d98">get_content_item</a>(0) );</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (pScore)</div><div class="line">    {</div><div class="line">        <span class="comment">//get the instrument (score part) to be edited. In this example, it is</span></div><div class="line">        <span class="comment">//the first instrument. </span></div><div class="line">        ImoInstrument* pInstr = pScore-&gt;get_instrument(0);</div><div class="line"></div><div class="line">        <span class="comment">//for inserting notes or other objects it is necessary to determine the </span></div><div class="line">        <span class="comment">//insertion point. For locating the insertion point there are</span></div><div class="line">        <span class="comment">//many possibilities, usually involving an iterator or a cursor object.</span></div><div class="line">        <span class="comment">//Lets use a cursor object:</span></div><div class="line">        ScoreCursor cursor(pDoc, pScore);</div><div class="line"></div><div class="line">        <span class="comment">//after creation the cursor will be pointing to the first object in</span></div><div class="line">        <span class="comment">//the score, the clef in this example</span></div><div class="line">        cursor.move_next();     <span class="comment">//now points to key signature</span></div><div class="line">        cursor.move_next();     <span class="comment">//now points to time signature</span></div><div class="line">        cursor.move_next();     <span class="comment">//done! now points to the first note, the D5 quarter note</span></div><div class="line">        ImoStaffObj* pAt = cursor.staffobj();        <span class="comment">//get the pointed object: note D5</span></div><div class="line"></div><div class="line">        <span class="comment">//change stem of note D5 to go up</span></div><div class="line">        ImoNote* pNote = <span class="keyword">static_cast&lt;</span>ImoNote*<span class="keyword">&gt;</span>(pAt);</div><div class="line">        pNote-&gt;set_stem_direction(k_stem_up);</div><div class="line"></div><div class="line">        <span class="comment">//insert a half D4 note in voice 2, with stem down</span></div><div class="line">        stringstream errormsg;</div><div class="line">        <span class="keywordflow">if</span> (!pInstr-&gt;insert_staffobj_at(pAt, <span class="stringliteral">&quot;(n d4 h v2 (stem down))&quot;</span>, errormsg))</div><div class="line">        {</div><div class="line">            <span class="comment">//error. An explanation is in errormsg</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">//once the updates are finished, invoke close() method for</span></div><div class="line">        <span class="comment">//for updating the internal data structures. This equivalent to</span></div><div class="line">        <span class="comment">//invoking pDoc-&gt;end_of_changes(); but will only rebuild</span></div><div class="line">        <span class="comment">//the structures associated to the modified score</span></div><div class="line">        pScore-&gt;end_of_changes();      </div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Here's what you should get: </p><div class="left-aligned"> <div class="image">
<img src="im-modification-api-2.png" alt="im-modification-api-2.png"/>
<div class="caption">
Example 2: Score generated by previous code.</div></div>
</div><h2><a class="anchor" id="im-modification-intro-example-3"></a>
3. Different ways for creating notes</h2>
<p>In previous examples the notes to add were created using LDP source code. In this example a different way for creating notes is shown. It demonstrates the right way for creating nodes before adding them to the internal model. This is required for using some low level API methods.</p>
<div class="fragment"><div class="line"><span class="comment">//create empty document</span></div><div class="line"><span class="keyword">delete</span> m_pPresenter;</div><div class="line">m_pPresenter = m_lomse.new_document(ViewFactory::k_view_vertical_book);</div><div class="line"></div><div class="line"><span class="comment">//Add content to the document</span></div><div class="line"><span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div><div class="line">{</div><div class="line">    <span class="comment">//get the document to edit</span></div><div class="line">    <a class="code" href="classDocument.html">Document</a>* pDoc = m_pPresenter-&gt;get_document_raw_ptr();</div><div class="line"></div><div class="line">    <span class="comment">//add an empty score to the document</span></div><div class="line">    ImoScore* pScore = pDoc-&gt;<a class="code" href="classDocument.html#aa26dcafd3c5cd6f6d597893c49755309">add_score</a>();</div><div class="line"></div><div class="line">    <span class="comment">//add an instrument (an score part) to the score</span></div><div class="line">    ImoInstrument* pInstr = pScore-&gt;add_instrument();</div><div class="line"></div><div class="line">    <span class="comment">//add some content to this instrument</span></div><div class="line">    pInstr-&gt;add_clef(<a class="code" href="group__enumerations.html#ggae2b8bc4155c37c3b10224456733664e4a34698de0a0d67e464fab9bbc29366173">k_clef_G2</a>);            <span class="comment">//G clef on second line</span></div><div class="line">    pInstr-&gt;add_key_signature(<a class="code" href="group__enumerations.html#gga6fcf17d0c9110b9471e695a30cf81959a4e4377b7e697f166796c989f6e901d88">k_key_D</a>);     <span class="comment">//D major key signature</span></div><div class="line">    pInstr-&gt;add_time_signature(2, 4);       <span class="comment">// 2/4 time signature</span></div><div class="line"></div><div class="line">    <span class="comment">//create the first note to insert: D4 half note</span></div><div class="line">    <span class="comment">//The following code shows the right way for creating nodes before</span></div><div class="line">    <span class="comment">//adding them to the model by using the ImFactory object (in lomse_im_factory.h).</span></div><div class="line">    ImoNote* pNote = <span class="keyword">static_cast&lt;</span>ImoNote*<span class="keyword">&gt;</span>( ImFactory::inject(<a class="code" href="group__enumerations.html#gga51de1c04259c674284dd0c9f4d0d651fa26b91ca57f2fa0d8a5055e49eaed9bcc">k_imo_note</a>, pDoc) );</div><div class="line">    pNote-&gt;set_note_type_and_dots(<a class="code" href="group__enumerations.html#gga09a15f850423776c0a4c4e6cc43e7dfcab35c103a5dd42ae503540770c4093211">k_half</a>, 0);</div><div class="line">    pNote-&gt;set_voice(1);</div><div class="line">    pNote-&gt;set_notated_pitch(<a class="code" href="group__enumerations.html#ggaeae8853f80e4ededd64180f81d0083fba33623c23a56ce288029d618d059a1606">k_step_D</a>, 4, <a class="code" href="group__enumerations.html#gga4c1fdff1651be19b8880fab9921cabd6a0e22b622238ef63b5f5a697ffee982c6">k_no_accidentals</a>);</div><div class="line">    pInstr-&gt;insert_staffobj_at(<span class="keyword">nullptr</span>, pNote);     <span class="comment">//append at end</span></div><div class="line"></div><div class="line">    pInstr-&gt;add_object(<span class="stringliteral">&quot;(r h)&quot;</span>);            <span class="comment">//add a rest, duration: half</span></div><div class="line">    pInstr-&gt;add_barline(<a class="code" href="group__enumerations.html#ggac2b9227b141b8d8aff14a30886e81b98a90555dae7a49d77cbda590b701459c61">k_barline_simple</a>);  <span class="comment">//add barline to finish first measure</span></div><div class="line">    pInstr-&gt;add_object(<span class="stringliteral">&quot;(n f4 q.)&quot;</span>);        <span class="comment">//add note: flat F4 dotted quarter note</span></div><div class="line">    pInstr-&gt;add_object(<span class="stringliteral">&quot;(n a4 e)&quot;</span>);         <span class="comment">//add the third note: A4 8th note</span></div><div class="line"></div><div class="line">    <span class="comment">//update the internal data structures</span></div><div class="line">    pScore-&gt;end_of_changes();</div><div class="line">}</div></div><!-- fragment --><p>Here's what you should get: </p><div class="left-aligned"> <div class="image">
<img src="im-modification-api-3.png" alt="im-modification-api-3.png"/>
<div class="caption">
Example 3: Score generated by previous code.</div></div>
</div><p>Notice that we didn't add a barline at the end. Therefore the last measure is not finished and the staff lines run until the right margin of the page.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>Finish the low level edition API overview</dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Wed Apr 22 2020 10:26:01 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
